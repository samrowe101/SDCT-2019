---
title: "Randomized controlled non-inferiority trial investigating the effect of two selective dry cow therapy protocols on antibiotic use and udder health - cow-level outcomes"
date: August 1st, 2019
author: Sam Rowe (samrowe101@gmail.com)
 
output:
  html_document:
    df_print: paged
    toc: true

    
---

#Note to reader

This page contains an output log for analysis. Please contact Sam Rowe (samrowe101@gmail.com) if you have questions. 

<br>
<br>
<br>

```{css, include=FALSE}
pre code {
 white-space: 
}
```

```{r setup, include=FALSE}
library(knitr)

#Mac
knitr::opts_knit$set(root.dir = "~/Dropbox/R backup/SDCT - R")

#Windows
#knitr::opts_knit$set(root.dir = "C:/Users/rowe0122/Dropbox/R backup/SDCT - R")

knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE)
```


<br>
<br>

# Evaluate Data

Load data

```{r}
library(dplyr)
load(file="Baseline.Rdata")
load(file="SDCTCOW.Rdata")
load(file="SDCTCOWDHI.Rdata")

SDCTCOW = SDCTCOW %>%
  mutate(Tx = recode(SDCTCOW$Tx,
                     "0" = "Blanket", "1" = "Culture", "2" = "Algorithm"))

```

<br>
<br>
<br>

Import file BL (cows included for analysis) for descriptive statistics
```{r}
library(readr)
head(Baseline)
```

<br>
<br>
<br>


# Inspect data

```{r}
print(summarytools::dfSummary(Baseline, valid.col=FALSE, graph.magnif=0.5, varnumbers=F,style="grid"))
```

<br>
<br>
<br>


## Descriptive statistics of subjects at enrollment
Comparison of demographics for each treatment group at dry-off
```{r}
library(table1)
table1(~ Age + DOMY + DOSCC + PrevSCCHI + factor(PrevCM) + factor(Parity) | Tx, data=Baseline)
```

<br>
<br>
<br>


## Descriptive statistics of subjects at dry-off
Note that this table excludes cows (n=32) that were not included cow-level analysis (eg. cows with long or short dry periods).
```{r}
table1(~ Age + DOMY + DPlength + DOSCC + PrevSCCHI + PrevCM + Parity | Tx, data=SDCTCOW)
```
Groups appear to be well balanced before and after exclusions, indicating that randomization was successful, and that drop-out is unlikely to affect our assumption of exchangeability between treatment groups.

<br>
<br>
<br>
<br>

Comparison of herds
```{r}
library(table1)
table1(~ Tx + Age + DOMY + DPlength + DODIM + DOSCC + PrevSCCHI + PrevCM + Parity | FARMID, data=SDCTCOW)
```


<br>
<br>
<br>


# Outcome 1: Clinical mastitis
## Kaplan Meier curve & log rank test for clinical mastitis

```{r}
library(gmodels)
CrossTable(SDCTCOW$Tx,SDCTCOW$CM,prop.c=FALSE,prop.t=FALSE,prop.chisq = FALSE)
```

Kaplan Meier curve
```{r Survival}
library(survminer)
library(survival)

KM <- survfit(Surv(CMTAR, CM) ~ Tx, data = SDCTCOW)
ggsurvplot(KM, data = SDCTCOW,  title = "", pval = T, conf.int = F,risk.table.col = "Tx",risk.table = T, risk.table.y.text.col = TRUE , surv.plot.height = 5, legend.labs = c("Blanket","Culture","Algorithm"), tables.theme = theme_cleantable(), ggtheme = theme_bw())
```

<br>
<br>
<br>
<br>

Log-Rank test

```{r}
survdiff(Surv(CMTAR, CM) ~ Tx,data=SDCTCOW,rho=0)
```

<br>
<br>
<br>

## Cox proportional hazards regression for clinical mastitis (1-120 DIM)
## Model building plan

Model type: Cox proportional hazards analysis with farm included as a cluster variable (robust sandwich standard error estimator) to account for lack of indepedence. 

Step 1: Identify potential confouders using a directed acyclic graph (DAG)

Step 2: Identify correlated variables using pearson and kendalls correlation coefficients

Step 3: Create model with all potential confounders

Step 4: Investigate if covariates meet proportional hazards assumption

Step 5: Investigate potential effect measure modification

Step 6: Remove unneccesary covariates in backwards stepwise fashion using 10% rule (i.e. if hazard ratio for algorithm or culture changes by >10% after removing the covariate, the covariate is retained in the model)

Step 7: Report final model

<br>
<br>
<br>

### Step 1: DAG for clincal mastitis
This is used to identify variables that could be confounders if they are not balanced between treatment groups. 
```{r DAG}
library(DiagrammeR)
mermaid("graph LR
        T(Treatment)-->U(Clinical mastitis)
        A(Age)-->T
        P(Parity)-->T
        M(Yield at dry-off)-->T
        S(SCC during prev lactation)-->T
        C(CM in prev lact)-->T
        A-->U
        P-->U
        M-->U
        S-->U
        C-->U
        C-->M
        P-->C
        P-->S
        P-->M
        A-->P
        A-->C
        A-->S
        A-->M
        M-->S
        C-->S
        style A fill:#FFFFFF, stroke-width:0px
        style T fill:#FFFFFF, stroke-width:2px
        style P fill:#FFFFFF, stroke-width:0px
        style M fill:#FFFFFF, stroke-width:0px
        style S fill:#FFFFFF, stroke-width:0px
        style C fill:#FFFFFF, stroke-width:0px
        style I fill:#FFFFFF, stroke-width:0px
        style U fill:#FFFFFF, stroke-width:2px
        ")
```
According to this DAG, I may need to control for the following variables.

Parity ["Parity"]

Age ["Age"]

Yield at most recent test before dry off ["DOMY"]

Somatic cell count at last herd test during previous lactation ["DOSCC" or "PrevSCCHi"] <- likely to be correlated

Clinical mastitis in previous lactation ["PrevCM"]


<br>
<br>
<br>
<br>

### Step 2: Identify correlated covariates
Pearson correlation matrix among potential predictors
```{r}
library(psych)
cor <- Baseline[, c(6,7,9,10,11,13,14)]
cor$Parity <- as.numeric(cor$Parity)
cor <- cor(cor, use = "complete.obs")
corPlot(cor, numbers=T)
```


```{r}
cor <- Baseline[, c(6,7,9,10,11,13,14)]
cor$Parity <- as.numeric(cor$Parity)
cor <- cor(cor, use = "complete.obs",method="kendal")
corPlot(cor, numbers=T)
```

Age and Parity highly correlated as expected.  Will only offer parity. 

Previous lactation peak SCC is moderately correlated with SCC at last herd test (DOSCC). Will only offer DOSCC. 

<br>
<br>
<br>
<br>

### Step 3: Create model with all potential covariates
Cox proportional hazards regression for clinical mastitis (1-120 DIM)

Cows that did not calve or that had long/short dry periods are excluded. 
Cows with clinical mastitis prior to calving are included. 

Reasons for R censor = 120 DIM or culling/death

```{r full model}
SR <- coxph(Surv(CMTAR, CM) ~ Parity + DOMY + DOSCC + PrevCM + Tx + cluster(FARMID), data=SDCTCOW)
coxph(Surv(CMTAR, CM) ~ Parity + DOMY + DOSCC + PrevCM + Tx + cluster(FARMID), data=SDCTCOW)

#tidy(coxph(Surv(CMTAR, CM) ~ Tx + cluster(FARMID), data=SDCTCOW))
```


<br>
<br>
<br>

### Step 4: Schoenfield tests to assess assumption of proportional hazards for explanatory variables.

Parity, Tx and DOSCC violate the assumption of proportional hazards
```{r}
SR <- cox.zph(SR)
SR
```
<br>
<br>
<br>
<br>

Schoenfield residual plots to assess assumption of proportional hazards. 
```{r fig.height=8}
ggcoxzph(SR,var = c("TxCulture","TxAlgorithm"))
```

```{r fig.height=8}
ggcoxzph(SR,var = c("DOSCC", "DOMY"))
```
```{r fig.height=8}
ggcoxzph(SR,var = c("Parity2","Parity3"))
```
```{r fig.height=8}
ggcoxzph(SR,var = c("PrevCM1"))
```

<br>
<br>
<br>
<br>
I will deal with these covariates using stratification (i.e. fitting seperate baseline hazards)

I must create categorical variables to allow for this (not shown here). 

Dry off milk yield ["DOMY"] -> median split ("DOMYcat" = 0 / 1).

Dry off SCC - split at 200,000 cells (subclinical mastitis ["DOSCM"] = 0 / 1)

<br>
<br>
<br>
<br>
Show new variables
```{r}
SDCTCOWcheck <- SDCTCOW %>% select(Tx,CM,CMTAR,Cull2,Cull2TAR,DOSCC,DOSCM,DOMY,DOMYcat,Parity,PrevCM)
head(SDCTCOWcheck)
```
<br>
<br>
<br>
<br>

Run new cox model with stratified variables 
```{r}
library(broom)
SR <- coxph(Surv(CMTAR, CM) ~ strata(Parity) + strata(DOMYcat) + strata(DOSCM) + PrevCM + Tx + cluster(FARMID), data=SDCTCOW)
tidy(coxph(Surv(CMTAR, CM) ~ strata(Parity) + strata(DOMYcat) + strata(DOSCM) + PrevCM + Tx + cluster(FARMID), data=SDCTCOW))
```
<br>
<br>
<br>
<br>
Repeat Schoenfeld residuals

Tx no longer p < 0.05, but is close to the threshold (p = 0.08).
```{r}
SR <- cox.zph(SR)
SR
```
<br>
<br>
<br>
<br>
Will split time into 1-60 and 61-120 DIM to see if this difference is meaningful.

Cox model 1-60 DIM

Beta coefficient for Culture = -0.43, Algorithm = -0.08
```{r}
SR <- coxph(Surv(CMTAR60, CM60) ~ strata(Parity) + strata(DOMYcat) + strata(DOSCM) + PrevCM + Tx + cluster(FARMID), data=SDCTCOW)
tidy(coxph(Surv(CMTAR60, CM60) ~ strata(Parity) + strata(DOMYcat) + strata(DOSCM) + PrevCM + Tx + cluster(FARMID), data=SDCTCOW))
```
<br>
<br>
<br>
<br>
Cox model 61-120 DIM
Beta coefficient for Culture = 0.008, Algorithm = -.401
```{r}
SR <- coxph(Surv(CMTAR60120, CM60120) ~ strata(Parity) + strata(DOMYcat) + strata(DOSCM) + PrevCM + Tx + cluster(FARMID), data=SDCTCOW)
tidy(coxph(Surv(CMTAR60120, CM60120) ~ strata(Parity) + strata(DOMYcat) + strata(DOSCM) + PrevCM + Tx + cluster(FARMID), data=SDCTCOW))
```

Decision:  These differences aren't sufficient in my opinion to warrant pursuing the 1-60, 61-120 DIM models. An average of the two is appropriate.
<br>
<br>
<br>
<br>

### Step 5: Investigate effect measure modification

Unable to evluate interaction between Tx & FARMID using Cox regression - Bizzare SE's, won't converge. 
```{r}
mm0 <- coxph(Surv(CMTAR, CM) ~ Tx + FARMID + Tx:FARMID + PrevCM + strata(Parity) + strata(DOMYcat) + strata(DOSCM), data=SDCTCOW)
tidy(mm0)
```
<br>
<br>
<br>
<br>
Will use logistic regression to assess for interaction between Tx and farm: P > 0.05. 
```{r}
mm0 <- glm(CM ~ Tx*FARMID + PrevCM + Parity + DOMYcat + DOSCM, data=SDCTCOW, family=binomial)
car::Anova(mm0)
```

Decision: No treatment by herd effect measure modification

<br>
<br>
<br>
<br>
Assess effect measure modification with previous clinical mastitis using Cox regression. 
```{r}

a <- coxph(Surv(CMTAR, CM) ~ factor(Tx)*factor(PrevCM) + strata(Parity) + cluster(FARMID) + strata(DOMYcat) + strata(DOSCM), data=SDCTCOW)

library(aod)
wald.test(b = coef(a), Sigma = vcov(a), Terms = 4:5)

```

Wald test for interaction is p < 0.05.
<br>
<br>
<br>
<br>
Model output with interaction
```{r}
mm0 <- coxph(Surv(CMTAR, CM) ~ Tx*PrevCM + strata(Parity) + strata(DOMYcat) + strata(DOSCM) + cluster(FARMID), data=SDCTCOW)
tidy(mm0)
```
According to this interaction model, the HR (referent = Blanket Tx, no prev CM) for each group are:

Blanket:Prev0 = 1

Blanket:Prev1 = 2.1

Culture:PrevCM0 = 0.93

Culture:PrevCM1 = 0.97

Algorithm:PrevCM0 = 0.93

Algorithm:PrevCM1 = 1.14

This is a counter-intuitive result: hazards of clinical mastitis are higher in blanket cows with previous history of CM.

However, these effect estimates have wide confidence intervals, and this interaction model adds unnecessary complexity and does not change our conclusions. 

Decision: Report main effects. 

<br>
<br>
<br>
<br>

### Step 6: Remove unnecessary covariates (backwards selection using 10% rule)

The order for removing covariates will be in increasing likelihood of being a confounder, which is based on my knowledge about the variables and their distribution in treatment groups.

This order will be: DOMYcat, DOSCM, Parity, PrevCM

Step 6a: Full model
```{r}
mm0 <- tidy(coxph(Surv(CMTAR, CM) ~ strata(Parity) + strata(DOMYcat) + strata(DOSCM) + PrevCM + Tx + cluster(FARMID), data=SDCTCOW)) %>% select("term","estimate")
mm0$HR <- exp(mm0$estimate)
mm0
```
<br>
<br>
<br>
<br>

Step 6b: removing DOMYcat
```{r}
mm0 <- tidy(coxph(Surv(CMTAR, CM) ~ strata(Parity) + strata(DOSCM) + PrevCM + Tx + cluster(FARMID), data=SDCTCOW))%>% select("term","estimate")
mm0$HR <- exp(mm0$estimate)
mm0
```
Both HR (Culture and Algorithm) changed by <10%. DOMYcat stays out. 
<br>
<br>
<br>
<br>

Step 6c: removing DOSCM
```{r}
mm0 <- tidy(coxph(Surv(CMTAR, CM) ~ strata(Parity) + PrevCM + Tx + cluster(FARMID), data=SDCTCOW)) %>% select("term","estimate")
mm0$HR <- exp(mm0$estimate)
mm0
```
Both HR changed by <10%. DOMYcat stays out. 
<br>
<br>
<br>
<br>

Step 6d: removing Parity
```{r}
mm0 <- tidy(coxph(Surv(CMTAR, CM) ~ PrevCM + Tx + cluster(FARMID), data=SDCTCOW)) %>% select("term","estimate")
mm0$HR <- exp(mm0$estimate)
mm0
```
Both HR changed by <10%. Parity stays out.

<br>
<br>
<br>
<br>

Step 6e: removing PrevCM
```{r}
mm0 <- tidy(coxph(Surv(CMTAR, CM) ~ Tx + cluster(FARMID), data=SDCTCOW)) %>% select("term","estimate")
mm0$HR <- exp(mm0$estimate)
mm0
```
Both HR changed by <10%.  PrevCM stays out. 
<br>
<br>
<br>
<br>

### Step 7a: Reporting final cox model for clinical mastitis (1-120 DIM)
No covariates included, as no evidence for confounding.
```{r}

CoxCM <- tidy(coxph(Surv(CMTAR, CM) ~ Tx + cluster(FARMID), data=SDCTCOW))
CoxCM$HR <- exp(CoxCM$estimate)
CoxCM$LCL <- exp(CoxCM$conf.low)
CoxCM$UCL <- exp(CoxCM$conf.high)
CoxCM <- CoxCM %>% select(term,HR,LCL,UCL,robust.se,p.value)
CoxCM
```

<br>
<br>
<br>

#### Checking Schoenfield residuals for Tx in final model
```{r fig.height=8}
SR <- coxph(Surv(CMTAR, CM) ~ Tx + cluster(FARMID), data=SDCTCOW)
cox.zph(SR)
SR <- cox.zph(SR)
ggcoxzph(SR,var = c("TxCulture","TxAlgorithm"))
```
Sufficient evidence to use Cox model.

<br>
<br>
<br>


### Step 7b: Reporting final cox model for clinical mastitis (1-120 DIM) using P-value based backwards stepwise selection
```{r}
CoxCM <- coxph(Surv(CMTAR, CM) ~ Tx + Parity + cluster(FARMID), data=SDCTCOW) %>% tidy()
CoxCM$HR <- exp(CoxCM$estimate)
CoxCM$LCL <- exp(CoxCM$conf.low)
CoxCM$UCL <- exp(CoxCM$conf.high)
CoxCM <- CoxCM %>% select(term,HR,LCL,UCL,robust.se,p.value)
CoxCM
```
Estimates are very similar to those found using 10% rule.
<br>
<br>
<br>
<br>


# Outcome 2: Culling / Death
## Kaplan Meier curve & log rank test for culling/death

```{r}
library(gmodels)
CrossTable(SDCTCOW$Tx,SDCTCOW$Cull2,prop.c=FALSE,prop.t=FALSE,prop.chisq = FALSE)
```

Kaplan Meier curve
```{r fig.height=8}
KM <- survfit(Surv(Cull2TAR, Cull2) ~ Tx, data = SDCTCOW)
ggsurvplot(KM, data = SDCTCOW,  title = "", pval = T, conf.int = F,risk.table.col = "Tx",risk.table = T, risk.table.y.text.col = TRUE , surv.plot.height = 5, legend.labs = c("Blanket","Culture","Algorithm"), tables.theme = theme_cleantable(), ggtheme = theme_bw())
```
<br>
<br>
<br>
<br>

Log-Rank test
```{r}
survdiff(Surv(Cull2TAR, Cull2) ~ Tx,data=SDCTCOW,rho=0)
```

<br>
<br>
<br>



## Cox proportional hazards regression for culling or death (1-120 DIM)
## Model building plan

Model type: Cox proportional hazards analysis with farm included as a cluster variable to account for lack of indepedence.

Step 1: Identify potential confouders using a directed acyclic graph (DAG)

Step 2: Identify correlated variables using pearson and kendalls correlation coefficients

Step 3: Create model with all potential confounders

Step 4: Investigate if covariates meet proportional hazards assumption

Step 5: Investigate potential effect measure modification

Step 6: Remove unneccesary covariates in backwards stepwise fashion using 10% rule (i.e. if HR changes by >10% after removal of covariate, the covariate is retained in the model)

Step 7: Report final model


### Steps 1 & 2: Identify potential confouders using a directed acyclic graph (DAG)
```{r fig.width=10}
library(DiagrammeR)
mermaid("graph LR
        T(Treatment)-->U(Culling or Death)
        A(Age)-->T
        P(Parity)-->T
        M(Yield at dry-off)-->T
        S(SCC during prev lactation)-->T
        C(CM in prev lact)-->T
        A-->U
        P-->U
        M-->U
        S-->U
        C-->U
        C-->M
        P-->C
        P-->S
        P-->M
        A-->P
        A-->C
        A-->S
        A-->M
        M-->S
        C-->S
        style A fill:#FFFFFF, stroke-width:0px
        style T fill:#FFFFFF, stroke-width:2px
        style P fill:#FFFFFF, stroke-width:0px
        style M fill:#FFFFFF, stroke-width:0px
        style S fill:#FFFFFF, stroke-width:0px
        style C fill:#FFFFFF, stroke-width:0px
        style I fill:#FFFFFF, stroke-width:0px
        style U fill:#FFFFFF, stroke-width:2px
        ")
```
According to this DAG, I may need to control for the following variables:

Parity ["Parity"].  Will not offer Age ["Age"] as it is highly correlated.

Yield at most recent test before dry off ["DOMY"]

Somatic cell count at last herd test during previous lactation ["DOSCC"] <- will not offer PrevSCCHI as it was correlated with DOSCC

Clinical mastitis in previous lactation ["PrevCM"]

<br>
<br>
<br>
<br>

### Step 3: Create model with all potential confounders

Cows that did not calve are excluded (left censored)

Reason for R censor = 120 DIM

```{r}
library(broom)
library(survival)
coxph(Surv(Cull2TAR, Cull2) ~ Parity + DOMY + DOSCC + PrevCM + Tx + cluster(FARMID), data=SDCTCOW)
```
<br>
<br>
<br>
<br>

### Step 4: Investigate if covariates meet proportional hazards assumption
Both DOSCC and DOMY don't meet the assumption of proportional hazards


```{r}
SR <- cox.zph(coxph(Surv(Cull2TAR, Cull2) ~ Parity + DOMY + DOSCC + PrevCM + Tx + cluster(FARMID), data=SDCTCOW))
SR
```


<br>
<br>
<br>



Schoenfield residual plots
```{r fig.height=8}
ggcoxzph(SR,var = c("TxCulture","TxAlgorithm"))
```
<br>
<br>
<br>
<br>

DOSCC and DOMY don't meet the assumption of proportional hazards
```{r fig.height=8}
ggcoxzph(SR,var = c("DOSCC", "DOMY"))
```
```{r fig.height=8}
ggcoxzph(SR,var = c("Parity2","Parity3"))
```
```{r fig.height=8}
ggcoxzph(SR,var = c("PrevCM1"))
```
<br>
<br>
<br>
<br>

Refit cox model with seperate baselines (stratified) for DOMY and DOSCC.

No evidence of other time-varying covariates or predictors (Tx).  
```{r}
SR <- coxph(Surv(Cull2TAR, Cull2) ~ Parity + strata(DOMYcat) + strata(DOSCM) + PrevCM + Tx + cluster(FARMID), data=SDCTCOW)
SR <- cox.zph(SR)
SR
```
<br>
<br>
<br>
<br>

### Step 5: Assess for effect measure modification

Tx : FARMID - could not assess this using Cox regression as model did not converge or reported unusually large SEs for some interaction terms. 

```{r}
SR <- coxph(Surv(Cull2TAR, Cull2) ~ Tx*FARMID + Parity + PrevCM + Parity + strata(DOMYcat) + strata(DOSCM), data=SDCTCOW)
tidy(SR)
```
<br>
<br>
<br>
<br>
I will assess effect Tx:farm interaction using logistic regression: 

Wald test for interaction term was P > 0.05. 
```{r}
mm0 <- glm(CM ~ Tx*FARMID + Parity + PrevCM + Parity + DOMYcat + DOSCM, data=SDCTCOW)
car::Anova(mm0)
```
<br>
<br>
<br>
<br>
Assess for other interactions using Wald testfrom Cox regression. 

Wald test was P > 0.05 for Tx:PrevCM interaction
```{r}
mm0 <- coxph(Surv(Cull2TAR, Cull2) ~ Tx*PrevCM + Parity + strata(DOMYcat) + strata(DOSCM) + cluster(FARMID), data=SDCTCOW)
summary(mm0)
wald.test(b = coef(mm0), Sigma = vcov(mm0), Terms = 6:7)
```
<br>
<br>
<br>
<br>
Wald test was P < 0.05 for Tx:Parity interaction
. 
```{r}
mm0 <- coxph(Surv(Cull2TAR, Cull2) ~ Tx*Parity + PrevCM + strata(DOMYcat) + strata(DOSCM) + cluster(FARMID), data=SDCTCOW)
summary(mm0)
wald.test(b = coef(mm0), Sigma = vcov(mm0), Terms = 6:9)
```
<br> 
<br>
<br>
Investigate potential effect measure modification by doing stratified models

Parity = 1
Frequency table
```{r}
table(SDCTCOW$Tx[SDCTCOW$Parity==1],SDCTCOW$Cull2[SDCTCOW$Parity==1])
```
<br>
<br>
<br>

#### Model (Parity = 1)
```{r}
mm0 <- coxph(Surv(Cull2TAR, Cull2) ~ Tx + PrevCM + strata(DOMYcat) + strata(DOSCM) + cluster(FARMID), data=SDCTCOW[SDCTCOW$Parity==1,]) %>% tidy()
mm0$HR <- exp(mm0$estimate)
mm0$LCL <- exp(mm0$conf.low)
mm0$UCL <- exp(mm0$conf.high)
mm0 %>% select("term","HR","LCL","UCL")
```

<br>
<br>
<br>

#### Parity = 2

Frequency table
```{r}
table(SDCTCOW$Tx[SDCTCOW$Parity==2],SDCTCOW$Cull2[SDCTCOW$Parity==2])
```

```{r}
mm0 <- coxph(Surv(Cull2TAR, Cull2) ~ Tx + PrevCM + strata(DOMYcat) + strata(DOSCM) + cluster(FARMID), data=SDCTCOW[SDCTCOW$Parity==2,]) %>% tidy()
mm0$HR <- exp(mm0$estimate)
mm0$LCL <- exp(mm0$conf.low)
mm0$UCL <- exp(mm0$conf.high)
mm0 %>% select("term","HR","LCL","UCL")
```

<br>
<br>
<br>

#### Parity = 3 or greater
Frequency table
```{r}
table(SDCTCOW$Tx[SDCTCOW$Parity==3],SDCTCOW$Cull2[SDCTCOW$Parity==3])
```

```{r}
mm0 <- coxph(Surv(Cull2TAR, Cull2) ~ Tx + PrevCM + strata(DOMYcat) + strata(DOSCM) + cluster(FARMID), data=SDCTCOW[SDCTCOW$Parity==3,]) %>% tidy
mm0$HR <- exp(mm0$estimate)
mm0$LCL <- exp(mm0$conf.low)
mm0$UCL <- exp(mm0$conf.high)
mm0 %>% select("term","HR","LCL","UCL")
```

This finding suggests that potential culling risks associated with SDCT may be higher in parity 1 cows than in multiparous animals.  However these HR estimates in all 3 parity groups are imprecise (wide confidence intervals) because of a small number of culling/death events.  For example, in lactation 1 animals: 6 in BDCT, 11 in Algorithm and 12 in Culture. Therefore, this difference in effects across levels of parity may be due to chance alone, and not worth investigating too closely. 

Decision: Report main effects.

<br>
<br>
<br>

### Step 6: Remove unnecessary covariates (backwards selection using 10% rule)

The order for removing covariates will be in increasing likelihood of being a confounder, which is based on my knowledge about the variables and their distribution in treatment groups.

This order will be: DOMYcat, DOSCM, PrevCM, Parity

Step 6a: Full model
```{r}
mm0 <- coxph(Surv(Cull2TAR, Cull2) ~ Tx + PrevCM + Parity + strata(DOMYcat) + strata(DOSCM) + cluster(FARMID), data=SDCTCOW) %>% tidy() %>% select("term","estimate")
mm0$HR <- exp(mm0$estimate)
mm0
```
<br>
<br>
<br>
<br>
Step 6b: removing DOMYcat
```{r}
mm0 <- coxph(Surv(Cull2TAR, Cull2) ~ Tx + PrevCM + Parity + strata(DOSCM) + cluster(FARMID), data=SDCTCOW) %>% tidy() %>% select("term","estimate")
mm0$HR <- exp(mm0$estimate)
mm0
```
HR for culture and algorithm didn't change by >10%.  DOMYcat stays out. 
<br>
<br>
<br>
<br>

Step 6c: removing DOSCM
```{r}
mm0 <- coxph(Surv(Cull2TAR, Cull2) ~ Tx + PrevCM + Parity + cluster(FARMID), data=SDCTCOW) %>% tidy() %>% select("term","estimate")
mm0$HR <- exp(mm0$estimate)
mm0
```
HR changed by <10%.  DOSCM stays out. 
<br>
<br>
<br>
<br>

Step 6d: removing PrevCM
```{r}
mm0 <- coxph(Surv(Cull2TAR, Cull2) ~ Tx + Parity + cluster(FARMID), data=SDCTCOW) %>% tidy() %>% select("term","estimate")
mm0$HR <- exp(mm0$estimate)
mm0
```
HR changed by <10%.  Leave PrevCM out. 
<br>
<br>
<br>
<br>
Step 6e: removing Parity
```{r}
mm0 <- coxph(Surv(Cull2TAR, Cull2) ~ Tx + cluster(FARMID), data=SDCTCOW) %>% tidy() %>% select("term","estimate")
mm0$HR <- exp(mm0$estimate)
mm0
```
HR changed by <10%. Parity stays out.

<br>
<br>
<br>
<br>

### Step 7a: Final cox model for culling or death (1 - 120 DIM)
No covariates included, as no evidence for confounding.
```{r}
CoxCull <- coxph(Surv(Cull2TAR, Cull2) ~ Tx + cluster(FARMID), data=SDCTCOW) %>% tidy()
CoxCull$HR <- exp(CoxCull$estimate)
CoxCull$LCL <- exp(CoxCull$conf.low)
CoxCull$UCL <- exp(CoxCull$conf.high)
CoxCull <- CoxCull %>% select(term,HR,LCL,UCL,robust.se,p.value)
CoxCull
```


<br>
<br>
<br>


#### Check schoenfield residuals for final model
```{r fig.height=8}
SR <- coxph(Surv(Cull2TAR, Cull2) ~ Tx + cluster(FARMID), data=SDCTCOW)
cox.zph(SR)
SR <- cox.zph(SR)
ggcoxzph(SR,var = c("TxCulture","TxAlgorithm"))
```


### Step 7b: Final cox model for culling or death (1 - 120 DIM) using P-value based backwards stepwise selection
```{r}
CoxCull <- coxph(Surv(CullTAR, Cull2) ~ Tx + Parity + DOSCC + PrevCM + cluster(FARMID), data=SDCTCOW) %>% tidy()
CoxCull$HR <- exp(CoxCull$estimate)
CoxCull$LCL <- exp(CoxCull$conf.low)
CoxCull$UCL <- exp(CoxCull$conf.high)
CoxCull <- CoxCull %>% select(term,HR,LCL,UCL,robust.se,p.value)
CoxCull
```
Estimates are similar to 10% rule based approach
<br>
<br>
<br>
<br>
<br>
<br>
<br>



# Changing datasets: DHI dataset with multiple rows per cow

Dataset example
```{r DHIdata}
SDCTCOWDHI$Tx <- 
  factor(SDCTCOWDHI$Tx, 
         levels=c(0,1,2),
         labels=c("Blanket",
                  "Culture", 
                  "Algorithm"))

DHIcheck <- SDCTCOWDHI %>% select(Tx,CowID,FARMID,DIM,TestDIMcat20,LSCC,MY,Parity,PrevCM,DOMY,DOSCC)
head(DHIcheck, n=10)
```
<br>
<br>
<br>
<br>

# Inspect data
```{r}
DHIoutcome <- SDCTCOWDHI %>% select(SCC,MY,SCM)
DHIoutcome$logSCC <- log(DHIoutcome$SCC + 1)
#summarytools::dfSummary(DHIoutcome, style='grid')
print(summarytools::dfSummary(DHIoutcome, valid.col=FALSE, graph.magnif=0.8, varnumbers=F, style="grid"))
```
Very little missing data. Will do complete case analysis.
<br>
<br>
<br>
<br>

## Assessing normality for continuous outcome variables

Somatic cell count (log x 10,000 cells)
```{r}
library(qualityTools)
qqPlot(log(SDCTCOWDHI$SCC+1))
```

```{r}
hist(log(SDCTCOWDHI$SCC+1))
```
<br>
<br>
<br>
<br>
Milk yield (kg)
```{r}
qqPlot(SDCTCOWDHI$MY)
```
```{r}
hist(SDCTCOWDHI$MY)
```
<br>
<br>
<br>
<br>

# Outcome 3: Somatic cell count

## Modelling plan
Model type: Linear mixed models, random intercepts for farm and cow will be fitted to account for repeated measures within cows, and clustering of cows within herds

Step 1: Identify potential confouders using a directed acyclic graph (DAG)

Step 2: Identify correlated variables using pearson and kendalls correlation coefficients

Step 3: Create model with all potential confounders

Step 4: Investigate potential effect measure modification

Step 5: Remove unneccesary covariates in backwards stepwise fashion using 10% rule (i.e. if estimated difference in SCC changes by >10% after removing the covariate, the covariate is retained in the model)

Step 6: Report final model

Step 7: Model diagnostics

### Step 1 & 2 Identify potential confounders using a DAG
```{r fig.width=10}
library(DiagrammeR)
mermaid("graph LR
        T(Treatment)-->U(SCC)
        A(Age)-->T
        P(Parity)-->T
        M(Yield at dry-off)-->T
        S(SCC during prev lactation)-->T
        C(CM in prev lact)-->T
        D(Days in milk at test)-->U
        D-->T
        A-->U
        P-->U
        M-->U
        S-->U
        C-->U
        C-->M
        P-->C
        P-->S
        P-->M
        A-->P
        A-->C
        A-->S
        A-->M
        M-->S
        C-->S
        style A fill:#FFFFFF, stroke-width:0px
        style T fill:#FFFFFF, stroke-width:2px
        style P fill:#FFFFFF, stroke-width:0px
        style M fill:#FFFFFF, stroke-width:0px
        style S fill:#FFFFFF, stroke-width:0px
        style C fill:#FFFFFF, stroke-width:0px
        style I fill:#FFFFFF, stroke-width:0px
        style D fill:#FFFFFF, stroke-width:0px
        style U fill:#FFFFFF, stroke-width:2px
        ")
```
According to this DAG, I may need to control for the following variables:

Parity ["Parity"] <- Age not offered as highly correlated

Yield at most recent test before dry off ["DOMY"]

Somatic cell count at last herd test during previous lactation ["DOSCC"] <- PrevSCCHI not offered as correlated

Clinical mastitis in previous lactation ["PrevCM"]

Days in milk at herd test (category, 0-20 "10", 21-40 "30" etc) ["TestDIMcat20"]



<br>
<br>
<br>
<br>

### Step 3: Create model with all potential confounders
```{r}
library(lme4)
mm0 <- lmer(LSCC ~ Tx + TestDIMcat20 + Parity + DOSCC + DOMY + PrevCM + (1|FARMID/CowID), data=SDCTCOWDHI)
summary(mm0)
car::vif(mm0)
```
<br>
<br>
<br>
<br>

### Step 4: Investigate effect measure modification

Tx:FARM (P > 0.05)
```{r}
mm0 <- lmer(LSCC ~ Tx*FARMID + Parity + TestDIMcat20 + DOSCC + DOMY + PrevCM + (1|CowID), data=SDCTCOWDHI)
car::Anova(mm0)
```
<br>
<br>
<br>
<br>

Tx:DIM category at herd test (P > 0.05)
```{r}
mm0 <- lmer(LSCC ~ Tx*TestDIMcat20 + Parity + DOSCC + DOMY + PrevCM + (1|FARMID/CowID), data=SDCTCOWDHI)
car::Anova(mm0)
```
<br>
<br>
<br>
<br>
Tx:Parity (P > 0.05)
```{r}
mm0 <- lmer(LSCC ~ Tx*Parity + TestDIMcat20 + DOSCC + DOMY + PrevCM + (1|FARMID/CowID), data=SDCTCOWDHI)
car::Anova(mm0)
```
<br>
<br>
<br>
<br>
Tx:PrevCM (P > 0.05)
```{r}
mm0 <- lmer(LSCC ~ Tx*PrevCM + Parity + TestDIMcat20 + DOSCC + DOMY + (1|FARMID/CowID), data=SDCTCOWDHI)
car::Anova(mm0)
```
<br>
<br>
<br>
<br>
Tx:DOMY (P > 0.05)
```{r}
mm0 <- lmer(LSCC ~ Tx*DOMY + PrevCM + Parity + TestDIMcat20 + DOSCC + (1|FARMID/CowID), data=SDCTCOWDHI)
car::Anova(mm0)
```

### Step 5: Remove unneccesary covariates in backwards stepwise fashion using 10% rule

The order for removing covariates will be in increasing likelihood of being a confounder, which is based on my knowledge about the variables and their distribution in treatment groups.

This order will be: DOMY, Parity, PrevCM, DOSCC

TestDIMcat20 will not be removed.

Step 5a: Full model
```{r}
mm0 <- lmer(LSCC ~ Tx + PrevCM + Parity + TestDIMcat20 + DOSCC + DOMY + (1|FARMID/CowID), data=SDCTCOWDHI)
mm0 %>% tidy()
```
<br>
<br>
<br>
<br>
Step 5b: removing DOMY
```{r}
mm0 <- lmer(LSCC ~ Tx + PrevCM + Parity + TestDIMcat20 + DOSCC + (1|FARMID/CowID), data=SDCTCOWDHI) 
mm0%>% tidy()
```
Changed by <10%.  DOMY stays out. 
<br>
<br>
<br>
<br>
Step 5b: removing Parity
```{r}
mm0 <- lmer(LSCC ~ Tx + PrevCM + TestDIMcat20 + DOSCC + (1|FARMID/CowID), data=SDCTCOWDHI)
mm0 %>% tidy()
```
Changed by <10%. Parity stays out. 

<br>
<br>
<br>
<br>
Step 5c: removing PrevCM
```{r}
mm0 <- lmer(LSCC ~ Tx + TestDIMcat20 + DOSCC + (1|FARMID/CowID), data=SDCTCOWDHI) 
mm0 %>% tidy()
```
Changed by >10%. PrevCM stays in. 
<br>
<br>
<br>
<br>
Step 5d: removing DOSCC
```{r}
mm0 <- lmer(LSCC ~ Tx + PrevCM + TestDIMcat20 + (1|FARMID/CowID), data=SDCTCOWDHI)
mm0 %>% tidy()
```
Changed by > 10%.  DOSCC stays in. 
<br>
<br>
<br>
<br>

### Step 6a: Final model for SCC (1 - 120 DIM)
```{r}
mm0 <- lmer(LSCC ~ Tx + PrevCM + DOSCC + TestDIMcat20 + (1|FARMID/CowID), data=SDCTCOWDHI)
mm0 %>% tidy(conf.int=TRUE)
```

#### ICC for SCC (1 - 120 DIM)
```{r}
mm0 <- lmer(LSCC ~ 1 + (1|FARMID/CowID), data=SDCTCOWDHI)
summary(mm0)
```

ICC (CowID) = 0.35
ICC (FARMID) = 0.02

Most clustering is happening within cow (repeated measures). 

### Step 6b: Final model for SCC (1 - 120 DIM) using P-value based backwards selection
```{r}
lmer(LSCC ~ Tx + Parity + PrevCM + DOSCC + (1|FARMID/CowID), data=SDCTCOWDHI) %>% summary()

lmer(LSCC ~ Tx + Parity + PrevCM + DOSCC + (1|FARMID/CowID), data=SDCTCOWDHI) %>% car::Anova() %>% tidy()

```
Estimates are very similar to 10% rule based approach.
<br>
<br>
<br>
<br>

### Step 6c: Final model (using 10% rule) reported as estimated marginal means (~LSmeans)
Mean log SCC
```{r emmeans1}
library(emmeans)
mm0 <- lmer(LSCC ~ Tx + PrevCM + DOSCC + TestDIMcat20 + (1|FARMID/CowID), data=SDCTCOWDHI)
emm <- emmeans(mm0, ~Tx) %>% tidy()
emm
```


### Step 6c: Final model (using 10% rule) reported as back-transformed estimated marginal means (~LSmeans)
Geometric mean SCC
```{r}
mm0 <- lmer(LSCC ~ Tx + PrevCM + DOSCC + TestDIMcat20 + (1|FARMID/CowID), data=SDCTCOWDHI)
emm <- emmeans(mm0, ~Tx) %>% tidy()
emm$SCC <- exp(emm$estimate) 
emm$LCL <- exp(emm$asymp.LCL)
emm$UCL <- exp(emm$asymp.UCL)
emm <- emm %>% subset(select=c(Tx,SCC,LCL,UCL))
emm

```
<br>
<br>
<br>


Reported as back-transformed estimated marginal means by herd test day, no interaction with test DIM
```{r}
mm0 <- lmer(LSCC ~ Tx + TestDIMcat20 + DOSCC + PrevCM + (1|FARMID/CowID), data=SDCTCOWDHI)
atx <- c(10,30,50,70,90,110)
emm <- emmeans(mm0, ~Tx*TestDIMcat20, at=list(atx)) %>% tidy()
emm$SCC <- exp(emm$estimate)
emm$LCL <- exp(emm$asymp.LCL)
emm$UCL <- exp(emm$asymp.UCL)
emm <- emm %>% subset(select=c(Tx,TestDIMcat20,SCC,LCL,UCL))
curve <- ggplot(emm) + coord_cartesian(ylim = (c(0,100))) + aes(x=TestDIMcat20, y=SCC, group=Tx, colour=Tx) + geom_point() + geom_line(aes(colour=Tx,linetype=Tx)) + geom_ribbon(aes(ymin=emm$LCL, ymax=emm$UCL,colour=Tx,fill=Tx), linetype=0, alpha=0.1)
curve
```
<br>
<br>
<br>
<br>

Reported as back-transformed estimated marginal means by herd test day, with interaction with test DIM
```{r}
mm0 <- lmer(LSCC ~ Tx*TestDIMcat20 + PrevCM + DOSCC + (1|FARMID/CowID), data=SDCTCOWDHI)
atx <- c(10,30,50,70,90,110)
emm <- emmeans(mm0, ~Tx*TestDIMcat20, at=list(atx)) %>% tidy()
emm$SCC <- exp(emm$estimate)
emm$LCL <- exp(emm$asymp.LCL)
emm$UCL <- exp(emm$asymp.UCL)
emm <- emm %>% subset(select=c(Tx,TestDIMcat20,SCC,LCL,UCL))
curve <- ggplot(emm) + coord_cartesian(ylim = (c(0,100))) + aes(x=TestDIMcat20, y=SCC, group=Tx, colour=Tx) + geom_point() + geom_line(aes(colour=Tx,linetype=Tx)) + geom_ribbon(aes(ymin=emm$LCL, ymax=emm$UCL,colour=Tx,fill=Tx), linetype=0, alpha=0.1)
curve
```
<br>
<br>
<br>
<br>

### Step 7: Model diagnostics
Checking homoskedasticity assumption (variance of residuals)
```{r}
mm0 <- lmer(LSCC ~ Tx + TestDIMcat20 + (1|FARMID/CowID), data=SDCTCOWDHI)
ggplot(data.frame(eta=predict(mm0,type="link"),pearson=residuals(mm0,type="pearson")),
       aes(x=eta,y=pearson)) +
  geom_point() +
  theme_bw()
```


Checking normality of residuals
```{r}
qqnorm(residuals(mm0))
```

Evidence of small L tail. Although some evidence of heteroskedasticity and not perfectly normal residuals, I believe these are allowable for this model. 


# Outcome 4: Milk yield


## Modelling plan
Model type: Linear mixed models, random intercepts for farm and cow will be fitted to account for repeated measures within cows, and clustering of cows within herds

Step 1: Identify potential confouders using a directed acyclic graph (DAG)

Step 2: Identify correlated variables using pearson and kendalls correlation coefficients

Step 3: Create model with all potential confounders

Step 4: Investigate potential effect measure modification

Step 5: Remove unneccesary covariates in backwards stepwise fashion using 10% rule (i.e. if estimated difference in milk yield changes by >10% after removing the covariate, the covariate is retained in the model)

Step 6: Report final model

Step 7: Model diagnostics

### Step 1 & 2 Identify potential confounders using a DAG
```{r fig.width=10}
library(DiagrammeR)
mermaid("graph LR
        T(Treatment)-->U(Milk yield)
        A(Age)-->T
        P(Parity)-->T
        M(Yield at dry-off)-->T
        S(SCC during prev lactation)-->T
        C(CM in prev lact)-->T
        D(Days in milk at test)-->U
        D-->T
        A-->U
        P-->U
        M-->U
        S-->U
        C-->U
        C-->M
        P-->C
        P-->S
        P-->M
        A-->P
        A-->C
        A-->S
        A-->M
        M-->S
        C-->S
        style A fill:#FFFFFF, stroke-width:0px
        style T fill:#FFFFFF, stroke-width:2px
        style P fill:#FFFFFF, stroke-width:0px
        style M fill:#FFFFFF, stroke-width:0px
        style S fill:#FFFFFF, stroke-width:0px
        style C fill:#FFFFFF, stroke-width:0px
        style I fill:#FFFFFF, stroke-width:0px
        style D fill:#FFFFFF, stroke-width:0px
        style U fill:#FFFFFF, stroke-width:2px
        ")
```
According to this DAG, I may need to control for the following variables:

Parity ["Parity"] <- Age not offered as highly correlated

Yield at most recent test before dry off ["DOMY"]

Somatic cell count at last herd test during previous lactation ["DOSCC"] <- PrevSCCHI not offered as correlated

Clinical mastitis in previous lactation ["PrevCM"]

Days in milk at herd test (category, 0-20 "10", 21-40 "30" etc) ["TestDIMcat20"]

<br>
<br>
<br>
<br>

### Step 3: Create a model with all potential covariates

```{r}
mm0 <- lmer(MY ~ Tx + TestDIMcat20 + Parity + DOSCC + PrevCM + DOMY + (1|FARMID/CowID), data=SDCTCOWDHI)
summary(mm0)
car::vif(mm0)
```
<br>
<br>
<br>
<br>

### Step 4: Investigate effect measure modification

### Tx:FARM (P < 0.05)
```{r}
mm0 <- lmer(MY ~ Tx*FARMID + Parity + TestDIMcat20 + DOSCC + DOMY + PrevCM + (1|CowID), data=SDCTCOWDHI)
car::Anova(mm0)
```

Significant interaction term.

Descision: Revisit this after covariates are finalized.
<br>
<br>
<br>
<br>
Tx:DIM category at herd test (P > 0.05)
```{r}
mm0 <- lmer(MY ~ Tx*TestDIMcat20 + Parity + DOSCC + DOMY + PrevCM + (1|FARMID/CowID), data=SDCTCOWDHI)
car::Anova(mm0)
```
<br>
<br>
<br>
<br>
Tx:Parity (P > 0.05)
```{r}
mm0 <- lmer(MY ~ Tx*Parity + TestDIMcat20 + DOSCC + DOMY + PrevCM + (1|FARMID/CowID), data=SDCTCOWDHI)
car::Anova(mm0)
```
<br>
<br>
<br>
<br>
Tx:PrevCM (P > 0.05)
```{r}
mm0 <- lmer(MY ~ Tx*PrevCM + Parity + TestDIMcat20 + DOSCC + DOMY + (1|FARMID/CowID), data=SDCTCOWDHI)
car::Anova(mm0)
```
<br>
<br>
<br>
<br>

### Step 5: Remove unnecessary covariates using backwards selection (10% rule)

The order for removing covariates will be in increasing likelihood of being a confounder, which is based on my knowledge about the variables and their distribution in treatment groups.

This order will be: DOSCC, PrevCM, Parity, DOMY

TestDIMcat20 will not be removed (forced into model). 

 


Step 5a: Full model
```{r}
mm0 <- lmer(MY ~ Tx + PrevCM + Parity + TestDIMcat20 + DOSCC + DOMY + (1|FARMID/CowID), data=SDCTCOWDHI) 
mm0 %>% tidy() %>% subset(select=c(term,estimate))

```
<br>
<br>
<br>
<br>
Step 5b: Removing DOSCC
```{r}
mm0 <- lmer(MY ~ Tx + PrevCM + Parity + TestDIMcat20 + DOMY + (1|FARMID/CowID), data=SDCTCOWDHI) 
mm0 %>% tidy() %>% subset(select=c(term,estimate))
```
Changed by <10%. DOSCC stays out
<br>
<br>
<br>
<br>

Step 5c: removing PrevCM
```{r}
mm0 <- lmer(MY ~ Tx + Parity + TestDIMcat20 + DOMY + (1|FARMID/CowID), data=SDCTCOWDHI)  
mm0 %>% tidy() %>% subset(select=c(term,estimate))
```
Changed by < 10%. PrevCM stays out. 

<br>
<br>
<br>
<br>
Step 5d: removing Parity
```{r}
mm0 <- lmer(MY ~ Tx + TestDIMcat20 + DOMY + (1|FARMID/CowID), data=SDCTCOWDHI) 
mm0 %>% tidy() %>% subset(select=c(term,estimate))
```
Changed by >10%.  Parity stays in.
<br>
<br>
<br>

Step 5e: removing DOMY
```{r}
mm0 <- lmer(MY ~ Tx + Parity + TestDIMcat20 + (1|FARMID/CowID), data=SDCTCOWDHI) 
mm0 %>% tidy() %>% subset(select=c(term,estimate))
```
Changed by >10%.  DOMY stays in. 
<br>
<br>
<br>
<br>

### Revisit effect measure modification previously identified
Effect measure modification with herd (P < 0.05)
```{r}
mm0 <- lmer(MY ~ Tx*FARMID + TestDIMcat20 + Parity + DOMY + (1|CowID), data=SDCTCOWDHI)
car::Anova(mm0)
```

Decision - will investigate effect estimates stratified by herd
<br>
<br>
<br>
<br>

### Step 6a: Final model for milk yield (1 - 120 DIM), stratified by herd. 
Model output
```{r}
mm0 <- lmer(MY ~ Tx*FARMID + TestDIMcat20 + Parity + DOMY + (1|CowID), data=SDCTCOWDHI)
emmeans(mm0,pairwise ~ Tx | FARMID)
```
It appears that herd 2 (87 cows) and herd 6 (42 cows) have extreme results compared with the other herds.  In herd 2, BDCT had much higher MY than SDCT cows.  In herd 6, it was the opposite effect.  Given these were the smallest herds in the study, I will report a pooled result. 
<br>
<br>
<br>
<br>

### Step 6bi: Final model reported without herd interaction
Model output
```{r}
summary(lmer(MY ~ Tx + TestDIMcat20 + Parity + DOMY+ (1|FARMID/CowID), data=SDCTCOWDHI))
```

Model output (tidy)
```{r}
lmer(MY ~ Tx + TestDIMcat20 + Parity + DOMY + (1|FARMID/CowID), data=SDCTCOWDHI) %>% tidy(conf.int=TRUE)
```

#### ICC for MY (1 - 120 DIM)
```{r}
mm0 <- lmer(MY ~ 1 + (1|FARMID/CowID), data=SDCTCOWDHI)
summary(mm0)
```

ICC (CowID) = 0.25
ICC (FARMID) = 0.09


Emmeans without TestDIM interaction
```{r}
mm0 <- lmer(MY ~ Tx + TestDIMcat20 + Parity + DOMY+ (1|FARMID/CowID), data=SDCTCOWDHI)

emmeans(mm0,~Tx) %>% tidy
```


### Step 6bii: Final model reported without herd interaction (using P-value based backwards elimination)
Model output
```{r}
summary(lmer(MY ~ Tx + TestDIMcat20 + Parity + (1|FARMID/CowID), data=SDCTCOWDHI))
```


<br>
<br>
<br>
<br>

### Step 6biii: Final model (using 10% rule) reported as estimated marginal means by test DIM category (no interaction with test DIM)
```{r}
mm0 <- lmer(MY ~ Tx + TestDIMcat20 + Parity + DOMY + (1|FARMID/CowID), data=SDCTCOWDHI)

atx <- c(10,30,50,70,90,110)
emm <- emmeans(mm0, ~Tx*TestDIMcat20) %>% tidy()
emm$MY <- emm$estimate
emm$LCL <- emm$asymp.LCL
emm$UCL <- emm$asymp.UCL
emm %>% subset(select=c(Tx,TestDIMcat20,MY,LCL,UCL))
```

Plotting model as predicted values
```{r}
curve <- ggplot(emm) + coord_cartesian(ylim = (c(0,55))) + aes(x=TestDIMcat20, y=MY, group=Tx, colour=Tx) + geom_point() + geom_line(aes(colour=Tx,linetype=Tx)) + geom_ribbon(aes(ymin=emm$LCL, ymax=emm$UCL,colour=Tx,fill=Tx), linetype=0, alpha=0.1)
curve
```
<br>
<br>
<br>
<br>
Reported as estimated marginal means by test day category with interaction with herd test DIM
```{r emmeans}
mm0 <- lmer(MY ~ Tx*TestDIMcat20 + Parity + DOMY + (1|FARMID/CowID), data=SDCTCOWDHI)
atx <- c(10,30,50,70,90,110)
emm <- emmeans(mm0, ~Tx*TestDIMcat20, at=list(atx)) %>% tidy()
emm$MY <- emm$estimate
emm$LCL <- emm$asymp.LCL
emm$UCL <- emm$asymp.UCL
emm <- emm %>% subset(select=c(Tx,TestDIMcat20,MY,LCL,UCL))

curve <- ggplot(emm) + coord_cartesian(ylim = (c(0,55))) + aes(x=TestDIMcat20, y=MY, group=Tx, colour=Tx) + geom_point() + geom_line(aes(colour=Tx,linetype=Tx)) + geom_ribbon(aes(ymin=emm$LCL, ymax=emm$UCL,colour=Tx,fill=Tx), linetype=0, alpha=0.1)
curve
```

### Step 7: Model diagnostics
Checking homoskedasticity assumption (variance of residuals)
```{r}
mm0 <- lmer(MY ~ Tx + TestDIMcat20 + Parity +DOMY+ (1|FARMID/CowID), data=SDCTCOWDHI)
ggplot(data.frame(eta=predict(mm0,type="link"),pearson=residuals(mm0,type="pearson")),
       aes(x=eta,y=pearson)) +
  geom_point() +
  theme_bw()
```

Checking normality of residuals
```{r}
qqnorm(residuals(mm0))
```

I am happy with homoskedasticity and normal residuals assumptions

